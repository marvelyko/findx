@page
@model FindX.Pages.ViewMessagesModel
@{
    ViewData["Title"] = "View Messages";
}

<div class="main-container">
    <div class="card-modern fade-in">
        <div class="card-header-modern d-flex justify-content-between align-items-center">
            <div>
                <h1 style="margin-bottom: 0.5rem;">Messages</h1>
                <p class="text-muted mb-0" style="font-size: 0.9375rem;">Discover messages from others</p>
            </div>
            <button class="btn btn-secondary" id="refreshBtn" title="Refresh messages">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
        <div class="card-body-modern">
            <div id="messagesContainer">
                <div class="empty-state">
                    <i class="bi bi-hourglass-split empty-state-icon"></i>
                    <p>Loading messages...</p>
                </div>
            </div>
        </div>
        <div class="card-footer-modern">
            <div class="d-grid">
                <button class="btn btn-danger btn-lg" id="finishBtn">
                    <i class="bi bi-check-circle"></i> Finish
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let sessionId = localStorage.getItem('sessionId');
        if (!sessionId) {
            sessionId = crypto.randomUUID();
            localStorage.setItem('sessionId', sessionId);
        }

        const currentMessageId = localStorage.getItem('currentMessageId');

        async function loadMessages() {
            try {
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '<div class="empty-state"><i class="bi bi-hourglass-split empty-state-icon"></i><p>Loading messages...</p></div>';

                const response = await fetch(`/api/messages/others/${sessionId}`);
                const messages = await response.json();
                
                if (messages.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state fade-in">
                            <i class="bi bi-inbox empty-state-icon"></i>
                            <h5 style="color: var(--text-primary); margin-bottom: 0.5rem;">No messages yet</h5>
                            <p style="color: var(--text-secondary);">Check back later to see messages from others!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = messages.map((msg, index) => `
                    <div class="message-card fade-in" data-message-id="${msg.id}" style="animation-delay: ${index * 0.1}s">
                        ${msg.hasMutualConsent ? `
                            <div class="message-content">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="flex-grow-1">
                                        <h5 class="mb-1" style="font-weight: 600; color: var(--text-primary);">${escapeHtml(msg.name)}</h5>
                                        <small class="text-muted">
                                            <i class="bi bi-clock"></i> ${formatDate(msg.createdAt)}
                                        </small>
                                    </div>
                                    <span class="badge" style="background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 0.5rem 1rem; border-radius: 20px;">
                                        <i class="bi bi-unlock"></i> Visible
                                    </span>
                                </div>
                                ${msg.photoPath ? `
                                    <div class="mb-3">
                                        <img src="${msg.photoPath}" class="photo-preview" alt="Photo" style="max-width: 100%;">
                                    </div>
                                ` : ''}
                                <p class="mb-0" style="color: var(--text-primary); line-height: 1.7; font-size: 0.9375rem;">${escapeHtml(msg.messageText)}</p>
                            </div>
                        ` : `
                            <div class="message-hidden">
                                <i class="bi bi-lock message-hidden-icon"></i>
                                <h5 style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Hidden Message</h5>
                                <p class="text-muted mb-3" style="font-size: 0.875rem;">This message is waiting for mutual consent</p>
                                ${!msg.hasConsent ? `
                                    <button class="btn btn-primary view-message-btn" data-message-id="${msg.id}">
                                        <i class="bi bi-eye"></i> Request to View
                                    </button>
                                ` : `
                                    <div style="padding: 1rem; background: rgba(99, 102, 241, 0.1); border-radius: 12px; color: var(--primary);">
                                        <i class="bi bi-hourglass-split"></i> Waiting for mutual consent...
                                    </div>
                                `}
                            </div>
                        `}
                    </div>
                `).join('');

                // Attach event listeners
                document.querySelectorAll('.view-message-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const messageId = parseInt(this.getAttribute('data-message-id'));
                        await requestView(messageId);
                    });
                });
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('messagesContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle empty-state-icon" style="color: var(--danger);"></i>
                        <h5 style="color: var(--danger); margin-bottom: 0.5rem;">Failed to load messages</h5>
                        <p style="color: var(--text-secondary);">Please refresh and try again.</p>
                    </div>
                `;
            }
        }

        async function requestView(messageId) {
            const btn = document.querySelector(`[data-message-id="${messageId}"].view-message-btn`);
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Requesting...';
            }

            try {
                const response = await fetch('/api/messages/request-view', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messageId: messageId,
                        viewerSessionId: sessionId
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    if (result.hasMutualConsent) {
                        // Show success message
                        showNotification('Mutual consent achieved! The message is now visible.', 'success');
                        await loadMessages();
                    } else {
                        showNotification('View request sent. Waiting for mutual consent...', 'info');
                        await loadMessages();
                    }
                } else {
                    showNotification('Failed to request view. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error requesting view:', error);
                showNotification('An error occurred. Please try again.', 'error');
            }
        }

        function showNotification(message, type) {
            // Simple notification - you could enhance this with a toast library
            const bgColor = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--primary)';
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                animation: fadeIn 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeIn 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        document.getElementById('finishBtn').addEventListener('click', async function() {
            if (!currentMessageId) {
                window.location.href = '/';
                return;
            }

            if (confirm('Are you sure you want to finish? Your message will be deleted.')) {
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';

                try {
                    const response = await fetch(`/api/messages/${currentMessageId}/${sessionId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        localStorage.removeItem('currentMessageId');
                        window.location.href = '/';
                    } else {
                        showNotification('Failed to delete message. Please try again.', 'error');
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-check-circle"></i> Finish';
                    }
                } catch (error) {
                    console.error('Error deleting message:', error);
                    showNotification('An error occurred. Please try again.', 'error');
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-check-circle"></i> Finish';
                }
            }
        });

        document.getElementById('refreshBtn').addEventListener('click', function() {
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            loadMessages().then(() => {
                this.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
            });
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            return date.toLocaleDateString();
        }

        // Load messages on page load
        loadMessages();

        // Auto-refresh every 10 seconds
        setInterval(loadMessages, 10000);
    </script>
}
